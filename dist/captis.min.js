/*! captis.js 2015-01-21 */
require=function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var bindSegment=null,createSlideSegments=function(){event.stopPropagation(),document.getElementById("captis").innerHTML+='<div id="captis_add">         <video id="add_video" preload controls></video>         <div id="segment_cont"><div id="captis_editor_segments"></div></div>         </div>';var parts=(document.getElementById("edit_video"),document.getElementById("captis_editor_segments")),container=document.getElementById("segment_cont"),steps=document.getElementsByClassName("step");bindSegment=document.getElementById("bind"),bindSegment.style.opacity="1.0",parts.innerHTML="";for(var i=0;i<steps.length;i++){parts.innerHTML+='<div class="impress_step" id="step_'+steps[i].id+'">step: '+steps[i].id+"</div>";var subs=steps[i].getElementsByClassName("substep");if(subs.length>0)for(var j=0;j<subs.length;j++)parts.innerHTML+='<div class="impress_step" id="step_'+steps[i].id+"_sub_"+(j+1)+'">step: '+steps[i].id+", substep: "+(j+1)+"</div>"}container.style.width="250px",document.addEventListener("click",selectSegment,!1),loadVideo()},past=null,selectSegment=function(e){var slide=e.target.id.split("_");if("step"==slide[0])if(null!=past&&(past.style.color="#D5DBD9"),e.target.style.color="#13AD87",bindSegment.style.color="#13AD87",past=e.target,slide[2]){impress().goto(slide[1]);for(var i=0;20>i;i++)impress().prev();impress().goto(slide[1]);for(var i=0;i<slide[3];i++)impress().next()}else{impress().goto(slide[1]);for(var i=0;20>i;i++)impress().prev();impress().goto(slide[1])}},loadVideo=function(){var request=new XMLHttpRequest,video=document.getElementById("add_video");request.open("GET","http://localhost:3000/media/captis.webm",!0),request.responseType="blob",request.onreadystatechange=function(){200===request.status&&4==request.readyState&&(video.src=window.URL.createObjectURL(this.response))},request.send()};exports.createSlideSegments=createSlideSegments},{}],2:[function(require,module,exports){var initializeEditor=function(){event.stopPropagation(),document.getElementById("captis").innerHTML+='<div id="captis_editor">             <div id="loading"><progress id="loading_segments" value="0"></progress></div>             <video id="edit_video" preload muted></video>             <div id="segment_cont"><div id="captis_editor_segments"></div></div>             <canvas id="segmentshot"></canvas>         </div>';var video=document.getElementById("edit_video"),parts=document.getElementById("captis_editor_segments"),container=document.getElementById("segment_cont"),loader=document.getElementById("loading_segments"),loading=document.getElementById("loading"),canvas=document.getElementById("segmentshot"),ctx=canvas.getContext("2d");parts.innerHTML="",video.src=window.videoURL,loader.setAttribute("max",window.segments.length-1),video.onloadedmetadata=function(){canvas.width=250,canvas.height=187;var i=0,loop=setInterval(function(){parts.innerHTML+='<div class="segment_box" id="segment_'+i+'">                     <i class="segment_time">'+window.formatDuration(window.segments[i].timestamp)+"</i>                 </div>",video.currentTime=window.segments[i].timestamp,ctx.drawImage(video,0,0,250,187);var image=canvas.toDataURL(),box=document.getElementById("segment_"+i);if(box.style.backgroundImage="url("+image+")",loader.value=i,i++,i==window.segments.length){container.style.width="250px",loading.style.display="none",video.style.display="block",video.pause(),video.currentTime=0,clearInterval(loop);for(var elements=document.getElementsByClassName("segment_box"),j=0;j<elements.length;j++)elements[j].addEventListener("click",editorPlaySegment,!1)}},100)},window.reloadEvents()},editorPlaySegment=function(){video=document.getElementById("edit_video");var index=parseInt(this.id.split("_")[1]);if(window.segment=index,window.canUpdate=!0,video.currentTime=window.segments[index].timestamp,video.muted=!1,impress().goto("overview"),impress().goto(window.segments[index].stepid),window.segments[index].next)for(var i=0;i<window.segments[index].next;i++)impress().next();if(window.segments[index].prev)for(var i=0;i<window.segments[index].prev;i++)impress().prev();console.log(window.slides,window.segments[index]),video.play()};exports.initializeEditor=initializeEditor},{}],Add:[function(require,module){module.exports=require("cMRE+B")},{}],"cMRE+B":[function(require,module){(function(global){(function(module,exports,define,browserify_shim__define__module__export__){var bindSegment=null,createSlideSegments=function(){event.stopPropagation(),document.getElementById("captis").innerHTML+='<div id="captis_add">         <video id="add_video" preload controls></video>         <div id="segment_cont"><div id="captis_editor_segments"></div></div>         </div>';var parts=(document.getElementById("edit_video"),document.getElementById("captis_editor_segments")),container=document.getElementById("segment_cont"),steps=document.getElementsByClassName("step");bindSegment=document.getElementById("bind"),bindSegment.style.opacity="1.0",parts.innerHTML="";for(var i=0;i<steps.length;i++){parts.innerHTML+='<div class="impress_step" id="step_'+steps[i].id+'">step: '+steps[i].id+"</div>";var subs=steps[i].getElementsByClassName("substep");if(subs.length>0)for(var j=0;j<subs.length;j++)parts.innerHTML+='<div class="impress_step" id="step_'+steps[i].id+"_sub_"+(j+1)+'">step: '+steps[i].id+", substep: "+(j+1)+"</div>"}container.style.width="250px",document.addEventListener("click",selectSegment,!1),loadVideo()},past=null,selectSegment=function(e){var slide=e.target.id.split("_");if("step"==slide[0])if(null!=past&&(past.style.color="#D5DBD9"),e.target.style.color="#13AD87",bindSegment.style.color="#13AD87",past=e.target,slide[2]){impress().goto(slide[1]);for(var i=0;20>i;i++)impress().prev();impress().goto(slide[1]);for(var i=0;i<slide[3];i++)impress().next()}else{impress().goto(slide[1]);for(var i=0;20>i;i++)impress().prev();impress().goto(slide[1])}},loadVideo=function(){var request=new XMLHttpRequest,video=document.getElementById("add_video");request.open("GET","http://localhost:3000/media/captis.webm",!0),request.responseType="blob",request.onreadystatechange=function(){200===request.status&&4==request.readyState&&(video.src=window.URL.createObjectURL(this.response))},request.send()};exports.createSlideSegments=createSlideSegments,browserify_shim__define__module__export__("undefined"!=typeof Add?Add:window.Add)}).call(global,void 0,void 0,void 0,function(ex){module.exports=ex})}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(require){function initializeToolbar(e){e.ctrlKey&&69==e.keyCode&&(captis.toolbar=!0,window.canUpdate=!1,document.getElementById("captis").innerHTML+='<div id="toolbar">                 <ul>                     <li><i id="camera" class="fa fa-video-camera captis_icon tooltip"><span class="tip-content">Turn on the camera</span></i></li>                     <li><i id="record" class="fa fa-circle tooltip"><span class="tip-content">Record video</span></i></li>                     <li><i id="pauserec" class="fa fa-pause captis_icon tooltip"><span class="tip-content">Pause video recording</span></i></li>                     <li><i id="save" class="fa fa-save captis_icon tooltip"><span class="tip-content">Save video</span></i></li>                     <li><i id="update" class="fa fa-plus-square captis_icon tooltip"><span class="tip-content">Add segments to video</span></i></li>                     <li><i id="edit" class="fa fa-pencil-square captis_icon tooltip"><span class="tip-content">Edit video segments</span></i></li>                     <li><i id="bind" class="fa fa-link captis_icon tooltip"><span class="tip-content">Bind segment</span></i></li>                     <li><i id="switch" class="fa fa-power-off captis_icon tooltip"><span class="tip-content">Close toolbar</span></i></li>                 </ul>             </div>',notification("Captis toolbar is ready to use."),document.removeEventListener("keyup",initializeToolbar,!1),document.addEventListener("keyup",closeToolbar,!1),document.getElementById("switch").addEventListener("click",closeToolbar,!1),document.getElementById("camera").addEventListener("click",mediaStream,!1),document.getElementById("edit").addEventListener("click",Editor.initializeEditor,!1),document.getElementById("update").addEventListener("click",Add.createSlideSegments,!1))}function notification(msg){var noti=document.getElementById("notify");noti&&(noti.outerHTML=""),document.getElementById("captis").innerHTML+='<div id="notify">             '+msg+'             <i id="close_notification" class="fa fa-times"></i>         </div>',document.getElementById("close_notification").addEventListener("mouseup",closeNotification,!1),captis.notified=!1,setTimeout(function(){closeNotification()},5e3)}function closeNotification(){if(!captis.notified)var noti=document.getElementById("notify"),index=1,loop=setInterval(function(){noti.style.opacity="0."+(10-index),10==index&&(clearInterval(loop),document.getElementById("close_notification").removeEventListener("mouseup",closeNotification,!1),noti.outerHTML="",captis.notified=!0),index++},60)}function clearSpace(){document.getElementById("switch").removeEventListener("click",closeToolbar,!1),document.getElementById("edit").removeEventListener("click",Editor.initializeEditor,!1),document.getElementById("update").removeEventListener("click",Add.createSlideSegments,!1),document.getElementById("camera").removeEventListener("click",closeToolbar,!1),document.getElementById("toolbar").outerHTML="",document.removeEventListener("keyup",closeToolbar,!1),document.addEventListener("keyup",initializeToolbar,!1);var editorSegments=document.getElementById("captis_editor"),addSegments=document.getElementById("captis_add");editorSegments&&(editorSegments.outerHTML=""),addSegments&&(addSegments.outerHTML=""),captis.streaming&&(captis.stream.stop(),document.getElementById("live_stream").outerHTML="",document.getElementById("timer").outerHTML="",captis.streaming=!1),captis.capturing&&(document.getElementById("polygon").outerHTML="",captis.capturing=!1)}function closeToolbar(e){event.stopPropagation(),(e.ctrlKey&&69==e.keyCode||"switch"==e.target.id)&&(clearSpace(),captis.toolbar=!1)}function reloadEvents(){document.getElementById("switch").addEventListener("click",closeToolbar,!1),document.getElementById("save").addEventListener("click",saveMedia,!1),document.getElementById("camera").addEventListener("click",mediaStream,!1)}function mediaStream(){navigator.getUserMedia?navigator.getUserMedia({video:!0,audio:!0},function(localMediaStream){captis.stream=localMediaStream,captis.streaming=!0,notification("Camera is on! Captis ready to capture video segments."),window.canUpdate&&(document.getElementById("edit_video").outerHTML=""),document.getElementById("captis").innerHTML+='<video id="live_stream" autoplay muted></video>                     <i id="timer"></i>',document.getElementById("captis").innerHTML+='<canvas id="polygon"></canvas>',document.getElementById("live_stream").src=window.URL.createObjectURL(localMediaStream),reloadEvents(),document.getElementById("camera").style.display="none",document.getElementById("record").style.display="block",document.getElementById("record").addEventListener("click",startRecording,!1)},function(err){console.log(err)}):console.log("getUserMedia not supported")}function timeFormat(seconds){var h=Math.floor(seconds/3600),m=Math.floor((seconds-3600*h)/60),s=Math.floor(seconds-3600*h-60*m);return h=10>h?"0"+h:h,m=10>m?"0"+m:m,s=10>s?"0"+s:s,h+":"+m+":"+s}function continueRecording(){captis.paused=!1,document.getElementById("live_stream").play(),document.getElementById("record").removeEventListener("click",continueRecording,!1),document.getElementById("pauserec").addEventListener("click",pauseRecording,!1),document.getElementById("record").style.display="none",document.getElementById("pauserec").style.display="block"}function pauseRecording(){captis.paused=!0,document.getElementById("live_stream").pause(),document.getElementById("record").removeEventListener("click",startRecording,!1),document.getElementById("record").addEventListener("click",continueRecording,!1),document.getElementById("record").style.display="block",document.getElementById("pauserec").style.display="none"}function startRecording(){captis.audio.recording=!0,event.stopPropagation(),document.getElementById("record").style.display="none",document.getElementById("pauserec").style.display="block",document.getElementById("pauserec").addEventListener("click",pauseRecording,!1);var video=document.getElementById("live_stream"),canvas=document.getElementById("polygon"),timer=document.getElementById("timer"),ctx=canvas.getContext("2d"),audioContext=new AudioContext,gainNode=audioContext.createGain(),audioInput=audioContext.createMediaStreamSource(captis.stream),bufferSize=1024,currentTime=(new Date).getTime(),index=0;audioInput.connect(gainNode),captis.audio.processor=audioContext.createScriptProcessor(bufferSize,1,1),captis.capturing=!0,captis.record=new Whammy.Video;var frameWidth=video.offsetWidth-14,frameHeight=video.offsetHeight-14;canvas.width=frameWidth,canvas.height=frameHeight,captis.audio.processor.onaudioprocess=function(e){if(!captis.paused&&captis.audio.recording){index%3==0&&(ctx.drawImage(video,0,0,frameWidth,frameHeight),captis.record.add(ctx,0)),index++;var channel=e.inputBuffer.getChannelData(0);channelData.push(new Float32Array(channel)),captis.audio.recordingSize+=bufferSize}},video.addEventListener("timeupdate",function(){timer.innerHTML=timeFormat(((new Date).getTime()-currentTime)/1e3)},!1),captureSegments(video),gainNode.connect(captis.audio.processor),captis.audio.processor.connect(audioContext.destination),reloadEvents()}function captureSegments(video){var nextStep=0,prevStep=0,stepId=null;window.onkeydown=function(e){setTimeout(function(){return 39==e.keyCode&&captis.impress.isStep?(nextStep>0&&(captis.impress.meta[stepId]=nextStep),nextStep=0,prevStep=0,captis.impress.isStep=!1,void captis.impress.segments.push({timestamp:Math.floor(video.currentTime),stepid:captis.impress.step,next:nextStep})):39!=e.keyCode||captis.impress.isStep?37==e.keyCode&&captis.impress.isStep?(prevStep=0,nextStep=0,captis.impress.isStep=!1,void captis.impress.segments.push({timestamp:Math.floor(video.currentTime),stepid:captis.impress.step,prev:prevStep})):37!=e.keyCode||captis.impress.isStep?void 0:(prevStep++,nextStep=0,void captis.impress.segments.push({timestamp:Math.floor(video.currentTime),stepid:captis.impress.step,prev:prevStep})):(nextStep++,prevStep=0,stepId=captis.impress.step,void captis.impress.segments.push({timestamp:Math.floor(video.currentTime),stepid:captis.impress.step,next:nextStep}))},1e3)}}function mergeBuffers(channelBuffer,recordingLength){for(var result=new Float32Array(recordingLength),offset=0,i=0;i<channelBuffer.length;i++){var buffer=channelBuffer[i];result.set(buffer,offset),offset+=buffer.length}return result}function writeUTFBytes(view,offset,string){for(var i=0;i<string.length;i++)view.setUint8(offset+i,string.charCodeAt(i))}function floatTo16BitPCM(output,offset,input){for(var i=0;i<input.length;i++,offset+=2){var s=Math.max(-1,Math.min(1,input[i]));output.setInt16(offset,0>s?32768*s:32767*s,!0)}}function saveMedia(){captis.audio.recording=!1,event.stopPropagation(),clearSpace(),captis.stream.stop();var audioData=mergeBuffers(channelData,captis.audio.recordingSize),buffer=new ArrayBuffer(44+2*audioData.length),view=new DataView(buffer);writeUTFBytes(view,0,"RIFF"),view.setUint32(4,32+2*audioData.length,!0),writeUTFBytes(view,8,"WAVE"),writeUTFBytes(view,12,"fmt "),view.setUint32(16,16,!0),view.setUint16(20,1,!0),view.setUint16(22,1,!0),view.setUint32(24,captis.audio.sampleRate,!0),view.setUint32(28,2*captis.audio.sampleRate,!0),view.setUint16(32,2,!0),view.setUint16(34,16,!0),writeUTFBytes(view,36,"data"),view.setUint32(40,2*audioData.length,!0),floatTo16BitPCM(view,44,audioData);var blob=new Blob([view],{type:"audio/wav"}),audioUrl=window.URL.createObjectURL(blob);document.getElementById("captis").innerHTML+='<audio id="metadata"></audio>';var audio=document.getElementById("metadata");audio.src=audioUrl,audio.onloadedmetadata=function(){for(var vidLen=Math.floor(audio.duration/captis.record.frames.length*1e3),differ=0,duraTion=0,i=0;i<captis.record.frames.length;i++)differ+=audio.duration/captis.record.frames.length*1e3-vidLen,differ>1?(duraTion=vidLen+1,differ-=1):duraTion=vidLen,captis.record.frames[i].duration=duraTion;var encodedFile=captis.record.compile(),json=new Blob([JSON.stringify({meta:captis.impress.meta,segments:captis.impress.segments,duration:timeFormat(audio.duration)})],{type:"application/json"}),formData=new FormData;if(window.canUpdate){json=new Blob([JSON.stringify({meta:captis.player.json.meta,segments:defineShift(Math.floor(audio.duration)),duration:captis.player.json.duration,update:[timeFormat(captis.player.json.segments[window.segment].timestamp),timeFormat(captis.player.json.segments[window.segment+1].timestamp)]})],{type:"application/json"}),formData.append("audio",blob,"audio.wav"),formData.append("video",encodedFile,"video.webm"),formData.append("data",json,"captis_new.json");var request=new XMLHttpRequest;request.open("POST","http://localhost:3000/update",!0),request.onload=function(){200===request.status?location.reload():console.log("Failed to upload")},request.send(formData)}else{formData.append("audio",blob,"audio.wav"),formData.append("video",encodedFile,"video.webm"),formData.append("data",json,"captis.json");var request=new XMLHttpRequest;request.open("POST","http://localhost:3000/merge",!0),request.onload=function(){200===request.status?location.reload():console.log("Failed to upload")},request.send(formData)}}}function defineShift(duration){console.log(duration);var timeDiff=captis.player.json.segments[window.segment+1].timestamp-captis.player.json.segments[window.segment].timestamp,shift=0;if(timeDiff>duration){shift=timeDiff-duration;for(var i=0;i<captis.player.json.segments.length;i++)i<=window.segment||(captis.player.json.segments[i].timestamp=captis.player.json.segments[i].timestamp-shift);return captis.player.json.segments}return duartion>timeDiff?shift=duartion-timeDiff:shift}function loadVideo(){var request=new XMLHttpRequest;request.open("GET","http://localhost:3000/media/captis.webm",!0),request.responseType="blob",request.onreadystatechange=function(){200===request.status&&4==request.readyState&&(captis.player.ready=!0,captis.player.objectUrl=window.URL.createObjectURL(this.response),window.videoURL=captis.player.objectUrl,notification("This slide contains video file! Please use ctr+w to load the segments."))},request.send()}function loadSegments(){var request=new XMLHttpRequest;request.open("GET","http://localhost:3000/media/captis.json",!0),request.onreadystatechange=function(){if(200===request.status&&4==request.readyState){captis.segments.ready=!0,captis.player.json=JSON.parse(this.response),window.segments=captis.player.json.segments,window.slides=captis.player.json.meta;for(var i=0;i<captis.player.json.segments.length;i++)-1==captis.player.slides.indexOf(captis.player.json.segments[i].stepid)&&captis.player.slides.push(captis.player.json.segments[i].stepid),captis.player.timestamps.push(captis.player.json.segments[i].timestamp)}},request.send()}function finishWatchingMode(e){e.ctrlKey&&87==e.keyCode&&captis.player.ready&&(captis.player.isOn=!0,document.getElementById("player").outerHTML="",document.removeEventListener("keyup",finishWatchingMode,!1),document.addEventListener("keyup",watchingMode,!1),location.reload())}function seekSegments(time){for(var i=0;i<captis.player.timestamps.length;i++){if(time<captis.player.timestamps[i]){captis.player.currentStep=i-1;break}if(time>captis.player.timestamps[i]&&captis.player.timestamps.length-1==i){captis.player.currentStep=i;break}}if(-1==captis.player.currentStep)impress().goto("overview"),impress().next();else if(captis.player.activeStep!=captis.player.currentStep){var slide=captis.player.slides.indexOf(captis.player.json.segments[captis.player.currentStep].stepid);if(slide>0?(impress().goto(captis.player.slides[slide-1]),impress().next()):(impress().goto("overview"),impress().next(),impress().next()),captis.player.json.segments[captis.player.currentStep].next>0)for(var i=0;i<captis.player.json.segments[captis.player.currentStep].next;i++)impress().next();if(captis.player.json.segments[captis.player.currentStep].prev>=0)for(var step=captis.player.json.meta[captis.player.json.segments[captis.player.currentStep].stepid]-captis.player.json.segments[captis.player.currentStep].prev,i=0;step>i;i++)impress().next();captis.player.activeStep=captis.player.currentStep}}function controlSegments(e){var video=document.getElementById("captis_made"),time=0;if(39==e.keyCode){captis.player.keypressed=!0;for(var i=0;i<captis.player.timestamps.length;i++)if(video.currentTime<captis.player.timestamps[i]){time=captis.player.timestamps[i];break}video.currentTime=time}if(37==e.keyCode){captis.player.keypressed=!0;for(var i=0;i<captis.player.timestamps.length;i++)if(video.currentTime<captis.player.timestamps[i]){if(0>i-2){time=0;break}time=captis.player.timestamps[i-2];break}video.currentTime=time}}function playVideo(e){e.target.style.display="none",document.getElementById("pause").style.display="inline",document.addEventListener("keydown",controlSegments,!1),document.getElementById("pause").addEventListener("click",pauseVideo,!1);var video=document.getElementById("captis_made"),timer=document.getElementById("ptimer"),buff=document.getElementById("pbuffer"),playbar=document.getElementById("playbar");video.play(),captis.player.timeupdate=setInterval(function(){seekSegments(Math.floor(video.currentTime)),timer.innerHTML=timeFormat(video.currentTime),buff.value=video.currentTime+5,playbar.value=video.currentTime,video.ended&&videoOnEnd()},1e3)}function pauseVideo(e){clearInterval(captis.player.timeupdate);var video=document.getElementById("captis_made");video.pause(),document.getElementById("play").style.display="inline",e.target.style.display="none",document.getElementById("play").addEventListener("click",playVideo,!1)}function videoOnEnd(){var video=document.getElementById("captis_made"),timer=document.getElementById("ptimer"),buff=document.getElementById("pbuffer"),playbar=document.getElementById("playbar");video.currentTime=0,timer.innerHTML="00:00:00",buff.value=0,playbar.value=0,document.getElementById("play").style.display="inline",document.getElementById("pause").style.display="none",document.getElementById("play").addEventListener("click",playVideo,!1),clearInterval(captis.player.timeupdate)}function setVolume(e){var video=document.getElementById("captis_made");video.volume=e.target.value,1==e.target.value&&(document.getElementById("highv").style.display="inline",document.getElementById("lowv").style.display="none",document.getElementById("offv").style.display="none"),e.target.value<1&&e.target.value>0&&(document.getElementById("highv").style.display="none",document.getElementById("lowv").style.display="inline",document.getElementById("offv").style.display="none"),0==e.target.value&&(document.getElementById("highv").style.display="none",document.getElementById("lowv").style.display="none",document.getElementById("offv").style.display="inline")}function seekVideo(e){clearInterval(captis.player.timeupdate);var video=document.getElementById("captis_made"),buff=document.getElementById("pbuffer"),timer=document.getElementById("ptimer"),playbar=document.getElementById("playbar");video.pause(),video.currentTime=e.target.value,video.play(),captis.player.timeupdate=setInterval(function(){seekSegments(Math.floor(video.currentTime)),timer.innerHTML=timeFormat(video.currentTime),buff.value=video.currentTime+5,playbar.value=video.currentTime,video.ended&&videoOnEnd()},1e3)}function fullScreen(e){var video=document.getElementById("captis_made");video.webkitRequestFullscreen&&(e.target.style.display="none",document.getElementById("exitfulls").style.display="inline",video.webkitRequestFullscreen())}function exitFullScreen(e){document.webkitExitFullscreen&&(document.getElementById("fulls").style.display="inline",e.target.style.display="none",document.webkitExitFullscreen())}function watchingMode(e){if(e.ctrlKey&&87==e.keyCode&&captis.player.ready&&captis.segments.ready){impress().goto(captis.player.json.segments[0].stepid),impress().prev(),captis.player.isOn=!0,captis.toolbar&&clearSpace(),document.getElementById("captis").innerHTML+='<div id="player">                 <video id="captis_made" preload></video>                 <div id="captis_controls">                     <div id="captis_player">                         <i id="play" class="fa fa-play captis_icon"></i>                         <i id="pause" class="fa fa-pause captis_icon"></i>                         <canvas id="segments"></canvas>                         <progress value="0" id="pbuffer"></progress>                         <input type="range" id="playbar" value="0">                         <i id="ptimer">00:00:00</i>                         <i id="highv" class="fa fa-volume-up captis_icon"></i>                         <i id="lowv" class="fa fa-volume-down captis_icon"></i>                         <i id="offv" class="fa fa-volume-off captis_icon"></i>                         <input type="range" id="volume" min="0" max="1" step="0.1" value="1">                         <i id="fulls" class="fa fa-eye captis_icon"></i>                         <i id="exitfulls" class="fa fa-eye-slash captis_icon"></i>                     </div>                 </div>             </div>';var video=document.getElementById("captis_made");video.src=captis.player.objectUrl,video.addEventListener("loadedmetadata",function(){document.getElementById("pbuffer").setAttribute("max",Math.floor(video.duration)),document.getElementById("playbar").setAttribute("max",Math.floor(video.duration));var canvas=document.getElementById("segments"),ctx=canvas.getContext("2d"),ratio=canvas.width/video.duration,position=0,segmentWidth=0;document.getElementById("play").addEventListener("click",playVideo,!1),document.getElementById("exitfulls").addEventListener("click",exitFullScreen,!1),document.getElementById("fulls").addEventListener("click",fullScreen,!1),document.getElementById("volume").addEventListener("change",setVolume,!1),document.getElementById("playbar").addEventListener("change",seekVideo,!1);for(var i=0;i<captis.player.timestamps.length;i++)segmentWidth=Math.floor(captis.player.timestamps[i]*ratio)-1,ctx.fillStyle="#13AD87",ctx.fillRect(position,0,segmentWidth,canvas.height),ctx.fillStyle="#FFF",ctx.fillRect(segmentWidth,0,1,canvas.height),position=segmentWidth+1;document.removeEventListener("keyup",watchingMode,!1),document.addEventListener("keyup",finishWatchingMode,!1)})}}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL;var AudioContext=window.AudioContext||window.webkitAudioContext,Whammy=require("Whammy"),Editor=require("./Editor"),Add=require("./Add"),channelData=[],captis={stream:null,frames:[],toolbar:!1,capturing:!1,streaming:!1,record:null,paused:!1,notified:!1,audio:{recordingSize:0,sampleRate:44100,recording:!1,processor:null},impress:{step:null,isStep:!1,segments:[],meta:{}},player:{objectUrl:null,ready:!1,timeupdate:null,json:null,timestamps:[],slides:[],isOn:!1,currentStep:null,activeStep:null,keypressed:!1},segments:{ready:!1}};window.reloadEvents=reloadEvents,window.formatDuration=timeFormat,document.addEventListener("impress:stepenter",function(e){captis.impress.isStep=!0,captis.impress.step=e.target.id},!1),document.addEventListener("keyup",initializeToolbar,!1),document.addEventListener("keyup",watchingMode,!1),loadVideo(),loadSegments()},{"./Add":1,"./Editor":2,Whammy:"lZHMST"}],Editor:[function(require,module){module.exports=require("fqJoPW")},{}],fqJoPW:[function(require,module){(function(global){(function(module,exports,define,browserify_shim__define__module__export__){var initializeEditor=function(){event.stopPropagation(),document.getElementById("captis").innerHTML+='<div id="captis_editor">             <div id="loading"><progress id="loading_segments" value="0"></progress></div>             <video id="edit_video" preload muted></video>             <div id="segment_cont"><div id="captis_editor_segments"></div></div>             <canvas id="segmentshot"></canvas>         </div>';var video=document.getElementById("edit_video"),parts=document.getElementById("captis_editor_segments"),container=document.getElementById("segment_cont"),loader=document.getElementById("loading_segments"),loading=document.getElementById("loading"),canvas=document.getElementById("segmentshot"),ctx=canvas.getContext("2d");parts.innerHTML="",video.src=window.videoURL,loader.setAttribute("max",window.segments.length-1),video.onloadedmetadata=function(){canvas.width=250,canvas.height=187;var i=0,loop=setInterval(function(){parts.innerHTML+='<div class="segment_box" id="segment_'+i+'">                     <i class="segment_time">'+window.formatDuration(window.segments[i].timestamp)+"</i>                 </div>",video.currentTime=window.segments[i].timestamp,ctx.drawImage(video,0,0,250,187);var image=canvas.toDataURL(),box=document.getElementById("segment_"+i);if(box.style.backgroundImage="url("+image+")",loader.value=i,i++,i==window.segments.length){container.style.width="250px",loading.style.display="none",video.style.display="block",video.pause(),video.currentTime=0,clearInterval(loop);for(var elements=document.getElementsByClassName("segment_box"),j=0;j<elements.length;j++)elements[j].addEventListener("click",editorPlaySegment,!1)}},100)},window.reloadEvents()},editorPlaySegment=function(){video=document.getElementById("edit_video");var index=parseInt(this.id.split("_")[1]);if(window.segment=index,window.canUpdate=!0,video.currentTime=window.segments[index].timestamp,video.muted=!1,impress().goto("overview"),impress().goto(window.segments[index].stepid),window.segments[index].next)for(var i=0;i<window.segments[index].next;i++)impress().next();if(window.segments[index].prev)for(var i=0;i<window.segments[index].prev;i++)impress().prev();console.log(window.slides,window.segments[index]),video.play()};exports.initializeEditor=initializeEditor,browserify_shim__define__module__export__("undefined"!=typeof Editor?Editor:window.Editor)}).call(global,void 0,void 0,void 0,function(ex){module.exports=ex})}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],Whammy:[function(require,module){module.exports=require("lZHMST")},{}],lZHMST:[function(require,module){(function(global){(function(module,exports,define,browserify_shim__define__module__export__){var Whammy=function(){function toWebM(frames,outputAsArray){for(var info=checkFrames(frames),CLUSTER_MAX_DURATION=3e4,EBML=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:doubleToString(info.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:25541},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:info.width,id:176},{data:info.height,id:186}]}]}]}]}],frameNumber=0,clusterTimecode=0;frameNumber<frames.length;){var clusterFrames=[],clusterDuration=0;
do clusterFrames.push(frames[frameNumber]),clusterDuration+=frames[frameNumber].duration,frameNumber++;while(frameNumber<frames.length&&CLUSTER_MAX_DURATION>clusterDuration);var clusterCounter=0,cluster={id:524531317,data:[{data:clusterTimecode,id:231}].concat(clusterFrames.map(function(webp){var block=makeSimpleBlock({discardable:0,frame:webp.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(clusterCounter)});return clusterCounter+=webp.duration,{data:block,id:163}}))};EBML[1].data.push(cluster),clusterTimecode+=clusterDuration}return generateEBML(EBML,outputAsArray)}function checkFrames(frames){for(var width=frames[0].width,height=frames[0].height,duration=frames[0].duration,i=1;i<frames.length;i++){if(frames[i].width!=width)throw"Frame "+(i+1)+" has a different width";if(frames[i].height!=height)throw"Frame "+(i+1)+" has a different height";if(frames[i].duration<0||frames[i].duration>32767)throw"Frame "+(i+1)+" has a weird duration (must be between 0 and 32767)";duration+=frames[i].duration}return{duration:duration,width:width,height:height}}function numToBuffer(num){for(var parts=[];num>0;)parts.push(255&num),num>>=8;return new Uint8Array(parts.reverse())}function strToBuffer(str){for(var arr=new Uint8Array(str.length),i=0;i<str.length;i++)arr[i]=str.charCodeAt(i);return arr}function bitsToBuffer(bits){var data=[],pad=bits.length%8?new Array(9-bits.length%8).join("0"):"";bits=pad+bits;for(var i=0;i<bits.length;i+=8)data.push(parseInt(bits.substr(i,8),2));return new Uint8Array(data)}function generateEBML(json,outputAsArray){for(var ebml=[],i=0;i<json.length;i++){var data=json[i].data;if("object"==typeof data&&(data=generateEBML(data,outputAsArray)),"number"==typeof data&&(data=bitsToBuffer(data.toString(2))),"string"==typeof data&&(data=strToBuffer(data)),data.length);var len=data.size||data.byteLength||data.length,zeroes=Math.ceil(Math.ceil(Math.log(len)/Math.log(2))/8),size_str=len.toString(2),padded=new Array(7*zeroes+7+1-size_str.length).join("0")+size_str,size=new Array(zeroes).join("0")+"1"+padded;ebml.push(numToBuffer(json[i].id)),ebml.push(bitsToBuffer(size)),ebml.push(data)}if(outputAsArray){var buffer=toFlatArray(ebml);return new Uint8Array(buffer)}return new Blob(ebml,{type:"video/webm"})}function toFlatArray(arr,outBuffer){null==outBuffer&&(outBuffer=[]);for(var i=0;i<arr.length;i++)"object"==typeof arr[i]?toFlatArray(arr[i],outBuffer):outBuffer.push(arr[i]);return outBuffer}function makeSimpleBlock(data){var flags=0;if(data.keyframe&&(flags|=128),data.invisible&&(flags|=8),data.lacing&&(flags|=data.lacing<<1),data.discardable&&(flags|=1),data.trackNum>127)throw"TrackNumber > 127 not supported";var out=[128|data.trackNum,data.timecode>>8,255&data.timecode,flags].map(function(e){return String.fromCharCode(e)}).join("")+data.frame;return out}function parseWebP(riff){for(var VP8=riff.RIFF[0].WEBP[0],frame_start=VP8.indexOf("Â*"),i=0,c=[];4>i;i++)c[i]=VP8.charCodeAt(frame_start+3+i);var width,horizontal_scale,height,vertical_scale,tmp;return tmp=c[1]<<8|c[0],width=16383&tmp,horizontal_scale=tmp>>14,tmp=c[3]<<8|c[2],height=16383&tmp,vertical_scale=tmp>>14,{width:width,height:height,data:VP8,riff:riff}}function parseRIFF(string){for(var offset=0,chunks={};offset<string.length;){var id=string.substr(offset,4),len=parseInt(string.substr(offset+4,4).split("").map(function(i){var unpadded=i.charCodeAt(0).toString(2);return new Array(8-unpadded.length+1).join("0")+unpadded}).join(""),2),data=string.substr(offset+4+4,len);offset+=8+len,chunks[id]=chunks[id]||[],chunks[id].push("RIFF"==id||"LIST"==id?parseRIFF(data):data)}return chunks}function doubleToString(num){return[].slice.call(new Uint8Array(new Float64Array([num]).buffer),0).map(function(e){return String.fromCharCode(e)}).reverse().join("")}function WhammyVideo(speed,quality){this.frames=[],this.duration=1e3/speed,this.quality=quality||.8}return WhammyVideo.prototype.add=function(frame,duration){if("undefined"!=typeof duration&&this.duration)throw"you can't pass a duration if the fps is set";if("undefined"==typeof duration&&!this.duration)throw"if you don't have the fps set, you ned to have durations here.";if("canvas"in frame&&(frame=frame.canvas),"toDataURL"in frame)frame=frame.toDataURL("image/webp",this.quality);else if("string"!=typeof frame)throw"frame must be a a HTMLCanvasElement, a CanvasRenderingContext2D or a DataURI formatted string";if(!/^data:image\/webp;base64,/gi.test(frame))throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp";this.frames.push({image:frame,duration:duration||this.duration})},WhammyVideo.prototype.compile=function(outputAsArray){return new toWebM(this.frames.map(function(frame){var webp=parseWebP(parseRIFF(atob(frame.image.slice(23))));return webp.duration=frame.duration,webp}),outputAsArray)},{Video:WhammyVideo,fromImageArray:function(images,fps,outputAsArray){return toWebM(images.map(function(image){var webp=parseWebP(parseRIFF(atob(image.slice(23))));return webp.duration=1e3/fps,webp}),outputAsArray)},toWebM:toWebM}}();browserify_shim__define__module__export__("undefined"!=typeof Whammy?Whammy:window.Whammy)}).call(global,void 0,void 0,void 0,function(ex){module.exports=ex})}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[5]);